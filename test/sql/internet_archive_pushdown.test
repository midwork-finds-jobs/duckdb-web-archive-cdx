# name: test/sql/internet_archive_pushdown.test
# description: Tests for internet_archive filter and limit pushdown using cdx_url column
# group: [sql]

# NOTE: When only cdx_url is selected with debug := true, no network request is made.
# This allows testing URL construction without httpfs or network access.

require web_archive

# Test cdx_url column exists only with debug := true
query I
SELECT column_name FROM (
    DESCRIBE SELECT cdx_url FROM wayback_machine(debug := true)
);
----
cdx_url

# Test cdx_url column type
query II
SELECT column_name, column_type FROM (
    DESCRIBE SELECT cdx_url FROM wayback_machine(debug := true)
);
----
cdx_url	VARCHAR

# ============================================
# LIMIT PUSHDOWN TESTS
# ============================================

# Test LIMIT pushdown appears in cdx_url
query I
SELECT cdx_url LIKE '%&limit=5%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
LIMIT 5;
----
true

# Test different LIMIT value
query I
SELECT cdx_url LIKE '%&limit=10%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
LIMIT 10;
----
true

# Test LIMIT 1
query I
SELECT cdx_url LIKE '%&limit=1%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
LIMIT 1;
----
true

# ============================================
# STATUS_CODE FILTER PUSHDOWN TESTS
# ============================================

# Test statuscode = 200 pushdown
query I
SELECT cdx_url LIKE '%filter=statuscode:200%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
  AND statuscode = 200
LIMIT 1;
----
true

# Test statuscode = 404 pushdown
query I
SELECT cdx_url LIKE '%filter=statuscode:404%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
  AND statuscode = 404
LIMIT 1;
----
true

# Test statuscode != pushdown (negative filter)
query I
SELECT cdx_url LIKE '%filter=!statuscode:404%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
  AND statuscode != 404
LIMIT 1;
----
true

# ============================================
# MIME_TYPE FILTER PUSHDOWN TESTS
# ============================================

# Test mimetype = 'text/html' pushdown
query I
SELECT cdx_url LIKE '%filter=mimetype:text/html%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
  AND mimetype = 'text/html'
LIMIT 1;
----
true

# Test mimetype != pushdown (negative filter)
query I
SELECT cdx_url LIKE '%filter=!mimetype:application/pdf%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
  AND mimetype != 'application/pdf'
LIMIT 1;
----
true

# ============================================
# TIMESTAMP FILTER PUSHDOWN TESTS
# ============================================

# Test timestamp > pushdown (from date)
query I
SELECT cdx_url LIKE '%&from=2024%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
  AND timestamp > '2024-01-01'
LIMIT 1;
----
true

# Test timestamp < pushdown (to date)
query I
SELECT cdx_url LIKE '%&to=2025%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
  AND timestamp < '2025-01-01'
LIMIT 1;
----
true

# Test timestamp BETWEEN pushdown (both from and to)
query I
SELECT cdx_url LIKE '%&from=2024%' AND cdx_url LIKE '%&to=2025%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
  AND timestamp BETWEEN '2024-01-01' AND '2025-01-01'
LIMIT 1;
----
true

# ============================================
# URL FILTER PUSHDOWN TESTS
# ============================================

# Test exact URL match
query I
SELECT cdx_url LIKE '%url=example.com&%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
LIMIT 1;
----
true

# Test wildcard URL
query I
SELECT cdx_url LIKE '%url=example.com/*%' FROM wayback_machine(debug := true)
WHERE url = 'example.com/*'
LIMIT 1;
----
true

# ============================================
# URL NOT LIKE PUSHDOWN TESTS
# ============================================

# Test url NOT LIKE pushdown - uses !original: filter
query I
SELECT cdx_url LIKE '%filter=!original:%' FROM wayback_machine(debug := true)
WHERE url LIKE 'example.com/%'
  AND url NOT LIKE 'example.com/%/%'
LIMIT 1;
----
true

# Test url NOT LIKE with simple pattern
query I
SELECT cdx_url LIKE '%filter=!original:.*test.*%' FROM wayback_machine(debug := true)
WHERE url = 'example.com/*'
  AND url NOT LIKE '%test%'
LIMIT 1;
----
true

# Test url LIKE + url NOT LIKE combined (common pattern for single-level paths)
query I
SELECT
    cdx_url LIKE '%url=example.com/*%'
    AND cdx_url LIKE '%filter=!original:%'
FROM wayback_machine(debug := true)
WHERE url LIKE 'example.com/%'
  AND url NOT LIKE 'example.com/%/%'
LIMIT 1;
----
true

# ============================================
# URLKEY FILTER PUSHDOWN TESTS
# ============================================

# Test urlkey suffix filter (LIKE '%apply') -> regex .*apply$
query I
SELECT cdx_url LIKE '%filter=urlkey:.*apply$%' FROM wayback_machine(debug := true)
WHERE url = 'example.com/*'
  AND urlkey LIKE '%apply'
LIMIT 1;
----
true

# Test urlkey NOT contains filter (NOT LIKE '%?%') -> !urlkey:.*\?.*
query I
SELECT cdx_url LIKE '%filter=!urlkey:%' FROM wayback_machine(debug := true)
WHERE url = 'example.com/*'
  AND NOT urlkey LIKE '%?%'
LIMIT 1;
----
true

# Test urlkey regexp_matches pushdown
query I
SELECT cdx_url LIKE '%filter=urlkey:.*test.*%' FROM wayback_machine(debug := true)
WHERE url = 'example.com/*'
  AND regexp_matches(urlkey, '.*test.*')
LIMIT 1;
----
true

# Test urlkey NOT regexp_matches pushdown
query I
SELECT cdx_url LIKE '%filter=!urlkey:.*spam.*%' FROM wayback_machine(debug := true)
WHERE url = 'example.com/*'
  AND NOT regexp_matches(urlkey, '.*spam.*')
LIMIT 1;
----
true

# Test urlkey NOT LIKE with parenthesis - uses backslash escaping
# Pattern 'com,example)/%/%' should become regex ^com,example\)/.*/.*
query I
SELECT cdx_url LIKE '%filter=!urlkey:^com,example\)/.*/.*%'
FROM wayback_machine(debug := true)
WHERE url LIKE 'example.com/%'
  AND urlkey NOT LIKE 'com,example)/%/%'
LIMIT 1;
----
true

# ============================================
# COMBINED FILTER TESTS
# ============================================

# Test multiple filters combined
query I
SELECT
    cdx_url LIKE '%filter=statuscode:200%'
    AND cdx_url LIKE '%filter=mimetype:text/html%'
    AND cdx_url LIKE '%&limit=5%'
FROM wayback_machine(debug := true)
WHERE url = 'example.com/*'
  AND statuscode = 200
  AND mimetype = 'text/html'
LIMIT 5;
----
true

# Test timestamp + statuscode + mimetype
query I
SELECT
    cdx_url LIKE '%&from=2024%'
    AND cdx_url LIKE '%filter=statuscode:200%'
    AND cdx_url LIKE '%filter=mimetype:text/html%'
FROM wayback_machine(debug := true)
WHERE url = 'example.com/*'
  AND timestamp > '2024-01-01'
  AND statuscode = 200
  AND mimetype = 'text/html'
LIMIT 1;
----
true

# ============================================
# COLLAPSE PARAMETER TESTS
# ============================================

# Test collapse parameter appears in URL
query I
SELECT cdx_url LIKE '%&collapse=urlkey%' FROM wayback_machine(debug := true, collapse := 'urlkey')
WHERE url = 'example.com/*'
LIMIT 1;
----
true

# Test collapse with timestamp
query I
SELECT cdx_url LIKE '%&collapse=timestamp:8%' FROM wayback_machine(debug := true, collapse := 'timestamp:8')
WHERE url = 'example.com/*'
LIMIT 1;
----
true

# ============================================
# COMPLEX URL VERIFICATION
# ============================================

# Verify complete URL structure for a complex query
query I
SELECT
    cdx_url LIKE 'https://web.archive.org/cdx/search/cdx?%'
    AND cdx_url LIKE '%url=example.com/*%'
    AND cdx_url LIKE '%&from=2024%'
    AND cdx_url LIKE '%&to=2025%'
    AND cdx_url LIKE '%&limit=10%'
    AND cdx_url LIKE '%filter=statuscode:200%'
    AND cdx_url LIKE '%filter=mimetype:text/html%'
    AND cdx_url LIKE '%filter=!urlkey:%'
    AND cdx_url LIKE '%&collapse=urlkey%'
FROM wayback_machine(debug := true, collapse := 'urlkey')
WHERE url = 'example.com/*'
  AND timestamp > '2024-01-01'
  AND timestamp < '2025-01-01'
  AND statuscode = 200
  AND mimetype = 'text/html'
  AND NOT urlkey LIKE '%?%'
LIMIT 10;
----
true

# ============================================
# FAST_LATEST PUSHDOWN TESTS (without ORDER BY)
# ============================================

# Test: Default LIMIT does NOT use fastLatest (positive limit)
query I
SELECT cdx_url LIKE '%&limit=5%' AND cdx_url NOT LIKE '%fastLatest%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
LIMIT 5;
----
true

# Test: Plain LIMIT without ORDER BY should use positive limit
query I
SELECT cdx_url LIKE '%&limit=10%' AND cdx_url NOT LIKE '%limit=-%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
LIMIT 10;
----
true

# ============================================
# SQL OFFSET PUSHDOWN TESTS
# ============================================

# Test: SQL OFFSET is pushed down to CDX API
query I
SELECT cdx_url LIKE '%&offset=50%' AND cdx_url LIKE '%&limit=10%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
LIMIT 10 OFFSET 50;
----
true

# Test: LIMIT without OFFSET has no offset in URL
query I
SELECT cdx_url NOT LIKE '%offset%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
LIMIT 5;
----
true

# Test: OFFSET 0 should not add offset parameter
query I
SELECT cdx_url NOT LIKE '%offset%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
LIMIT 10 OFFSET 0;
----
true

# ============================================
# IN EXPRESSION PUSHDOWN TESTS
# ============================================

# Test statuscode IN pushdown - converts to regex alternation
query I
SELECT cdx_url LIKE '%filter=statuscode:(200|301|302)%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
  AND statuscode IN (200, 301, 302)
LIMIT 1;
----
true

# Test statuscode IN with two values
query I
SELECT cdx_url LIKE '%filter=statuscode:(200|404)%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
  AND statuscode IN (200, 404)
LIMIT 1;
----
true

# Test mimetype IN pushdown - converts to regex alternation
query I
SELECT cdx_url LIKE '%filter=mimetype:(text/html|text/plain)%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
  AND mimetype IN ('text/html', 'text/plain')
LIMIT 1;
----
true

# Test mimetype IN with three values
query I
SELECT cdx_url LIKE '%filter=mimetype:(text/html|text/plain|application/json)%' FROM wayback_machine(debug := true)
WHERE url = 'example.com'
  AND mimetype IN ('text/html', 'text/plain', 'application/json')
LIMIT 1;
----
true

# Test combined statuscode IN and mimetype IN
query I
SELECT
    cdx_url LIKE '%filter=statuscode:(200|301)%'
    AND cdx_url LIKE '%filter=mimetype:(text/html|text/plain)%'
FROM wayback_machine(debug := true)
WHERE url = 'example.com'
  AND statuscode IN (200, 301)
  AND mimetype IN ('text/html', 'text/plain')
LIMIT 1;
----
true

# Test statuscode IN combined with other filters
query I
SELECT
    cdx_url LIKE '%filter=statuscode:(200|301|302)%'
    AND cdx_url LIKE '%&from=2024%'
    AND cdx_url LIKE '%&limit=10%'
FROM wayback_machine(debug := true)
WHERE url = 'example.com/*'
  AND statuscode IN (200, 301, 302)
  AND timestamp > '2024-01-01'
LIMIT 10;
----
true

# ============================================
# STAR WILDCARD IN SIMILAR TO TESTS
# ============================================

# Test urlkey NOT SIMILAR TO with * wildcard converts to .* in regex
# Pattern: a/* should become a/.* in the CDX regex
query I
SELECT cdx_url LIKE '%filter=!urlkey:%' AND cdx_url LIKE '%/.*%' FROM wayback_machine(debug := true)
WHERE url = 'example.com/*'
  AND urlkey NOT SIMILAR TO 'a/*/*'
LIMIT 1;
----
true

# Test urlkey SIMILAR TO with * wildcard converts to .* in regex
query I
SELECT cdx_url LIKE '%filter=urlkey:^test/.*$%' FROM wayback_machine(debug := true)
WHERE url = 'example.com/*'
  AND urlkey SIMILAR TO 'test/*'
LIMIT 1;
----
true

# ============================================
# URL SUFFIX (LIKE '%.domain.com') TESTS
# ============================================

# Test URL suffix pattern (subdomains) uses matchType=domain
query I
SELECT cdx_url LIKE '%url=*.example.com%' FROM wayback_machine(debug := true)
WHERE url LIKE '%.example.com'
LIMIT 1;
----
true

# Test URL suffix with different domain
query I
SELECT cdx_url LIKE '%url=*.example.org%' FROM wayback_machine(debug := true)
WHERE url LIKE '%.example.org'
LIMIT 1;
----
true

# Test URL suffix combined with other filters
query I
SELECT
    cdx_url LIKE '%url=*.example.com%'
    AND cdx_url LIKE '%filter=statuscode:200%'
    AND cdx_url LIKE '%&limit=5%'
FROM wayback_machine(debug := true)
WHERE url LIKE '%.example.com'
  AND statuscode = 200
LIMIT 5;
----
true

# Test URL suffix with timestamp filter
query I
SELECT
    cdx_url LIKE '%url=*.example.com%'
    AND cdx_url LIKE '%&from=2024%'
FROM wayback_machine(debug := true)
WHERE url LIKE '%.example.com'
  AND timestamp > '2024-01-01'
LIMIT 1;
----
true

