# name: test/sql/common_crawl.test
# description: test common_crawl extension
# group: [sql]

# Require statement will ensure this test is run with this extension loaded
require web_archive_cdx

# Test that httpfs is loaded (required for the extension)
query I
SELECT COUNT(*) >= 0 FROM duckdb_extensions() WHERE extension_name = 'httpfs' AND loaded = true;
----
true

# Test that common_crawl_index function exists and returns correct schema
query I
SELECT COUNT(*) FROM (
    SELECT * FROM common_crawl_index() LIMIT 0
);
----
0

# Test that the function returns the expected columns including new ones
query I
SELECT column_name FROM (
    DESCRIBE SELECT * FROM common_crawl_index()
) ORDER BY column_name;
----
crawl_id
digest
filename
length
mimetype
offset
response
statuscode
timestamp
url
warc

# Test that column types are correct
query II
SELECT column_name, column_type FROM (
    DESCRIBE SELECT * FROM common_crawl_index()
) WHERE column_name IN ('url', 'statuscode', 'offset', 'length', 'crawl_id')
ORDER BY column_name;
----
crawl_id	VARCHAR
length	BIGINT
offset	BIGINT
statuscode	INTEGER
url	VARCHAR

# Test that STRUCT columns exist with correct types
query II
SELECT column_name, column_type FROM (
    DESCRIBE SELECT * FROM common_crawl_index()
) WHERE column_name IN ('warc', 'response')
ORDER BY column_name;
----
response	STRUCT(body BLOB, headers MAP(VARCHAR, VARCHAR), http_version VARCHAR, "error" VARCHAR)
warc	STRUCT("version" VARCHAR, headers MAP(VARCHAR, VARCHAR))

# Test that internet_archive function exists
statement ok
SELECT * FROM wayback_machine() LIMIT 0;

# Test wayback_machine column list (cdx_url hidden by default)
query I
SELECT column_name FROM (
    DESCRIBE SELECT * FROM wayback_machine()
) ORDER BY column_name;
----
digest
length
mimetype
month
response
statuscode
timestamp
url
urlkey
year

# Test named parameters work
statement ok
SELECT * FROM common_crawl_index(max_results := 10) LIMIT 0;

# Test named parameters for internet_archive
statement ok
SELECT * FROM wayback_machine(max_results := 10) LIMIT 0;

# Test projection pushdown
statement ok
SELECT url, statuscode FROM common_crawl_index() LIMIT 0;

# Test filter pushdown
statement ok
SELECT * FROM common_crawl_index()
WHERE statuscode = 200
  AND mimetype = 'text/html'
LIMIT 0;

# Test LIMIT pushdown
statement ok
SELECT * FROM common_crawl_index()
WHERE statuscode = 200
LIMIT 0;

# Test accessing STRUCT fields
statement ok
SELECT response.body, response.headers, warc.version
FROM common_crawl_index()
LIMIT 0;

# Test accessing MAP in STRUCT
statement ok
SELECT response.headers['Content-Type']
FROM common_crawl_index()
LIMIT 0;

# Note: Testing with real Common Crawl data requires network access
# and may be slow. The tests above verify the schema and API work correctly
# without making actual network calls (LIMIT 0).
